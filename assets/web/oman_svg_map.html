<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>خريطة سلطنة عُمان (SVG)</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<style>
   :root{ --bg:#eef2f3; --base:#f8fafb; --stroke:#c9d3d8; --hover:#e1ecff; --active:#5b8ddf;
          --label:#1f2937; --label-shadow:#ffffff; }
   html,body{height:100%} body{margin:0;background:var(--bg);
     font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic UI","Noto Kufi Arabic","Tajawal",Arial,sans-serif}
   .toolbar{position:fixed; inset-inline-start:12px; top:12px; display:flex; gap:8px; z-index:10}
   .btn{border:0;border-radius:10px;padding:8px 12px;cursor:pointer;background:#fff;
        box-shadow:0 2px 8px rgba(0,0,0,.12);font-weight:600}
   svg{width:100%;height:100%}
   .gov{fill:var(--base);stroke:var(--stroke);stroke-width:1.2;cursor:pointer;transition:fill .15s}
   .gov:hover{fill:var(--hover)} .gov.active{fill:var(--active)}
   .label{font-weight:700;fill:var(--label);paint-order:stroke;stroke:var(--label-shadow);
          stroke-width:3px;text-anchor:middle;pointer-events:none}
   .island-dot{fill:#0f1e22}
   .island-label{font-weight:700;fill:#111827;paint-order:stroke;stroke:#fff;stroke-width:2px;pointer-events:none}
</style>
</head>
<body>
<div class="toolbar" dir="ltr">
<button id="resetBtn" class="btn">إعادة الضبط</button>
<button id="langBtn"  class="btn">English</button>
</div>
<svg id="chart" viewBox="0 0 1200 980" preserveAspectRatio="xMidYMid meet"></svg>
<script>
   // -------- حالة عامّة --------
   let isArabic = true;
   let activeId = null;
   const svg = d3.select('#chart');
   const g   = svg.append('g');
   const gPol= g.append('g');
   const gLbl= g.append('g');
   const gIsl= g.append('g');
   // أزرار
   document.getElementById('langBtn').addEventListener('click', ()=>{
     isArabic = !isArabic;
     document.getElementById('langBtn').textContent = isArabic ? 'English':'العربية';
     if (window.__GEO__) { drawProvinceLabels(window.__GEO__); drawIslands(); }
   });
   document.getElementById('resetBtn').addEventListener('click', ()=>{
     activeId=null; gPol.selectAll('path.gov').classed('active',false);
     if (window.__bbox__) zoomTo(window.__bbox__, 0, 1.15);
   });
   // أسماء عربية
   const arNames = new Map([
     ['muscat','مسقط'],
     ['alburaimi','البريمي'],['alburaymi','البريمي'],
     ['albatinahnorth','الباطنة الشمالية'],['albatnahnorth','الباطنة الشمالية'],['albattinahnorth','الباطنة الشمالية'],
     ['albatinahsouth','الباطنة الجنوبية'],['albatnahsouth','الباطنة الجنوبية'],['albattinahsouth','الباطنة الجنوبية'],
     ['addakhliyah','الداخلية'],['aldakhiliyah','الداخلية'],['adakhiliyah','الداخلية'],
     ['ashsharqiyahnorth','الشرقية الشمالية'],['asharqiyahnorth','الشرقية الشمالية'],['northeastashsharqiyah','الشرقية الشمالية'],
     ['ashsharqiyahsouth','الشرقية الجنوبية'],['asharqiyahsouth','الشرقية الجنوبية'],['southeastashsharqiyah','الشرقية الجنوبية'],
     ['addhahirah','الظاهرة'],['aldhahira','الظاهرة'],['aldhahirah','الظاهرة'],
     ['alwusta','الوسطى'],['dhofar','ظفار'],['musandam','مسندم'],
   ]);
   const islands = [
     { lon:58.90, lat:20.55, ar:'جزيرة مصيرة',   en:'Masirah Island',         dx:80,  dy:3, r:2.6, fs:11 },
     { lon:57.90, lat:17.45, ar:'جزر الحلانيات', en:'Al Hallaniyat Islands',  dx:-80, dy:3, r:2.6, fs:11 },
   ];
   function normalizeKey(s){
     if(!s) return ''; return s.toString().toLowerCase().replace(/\s+/g,'')
       .replace(/[-_']/g,'').normalize('NFKD').replace(/[^\x00-\x7F]/g,'');
   }
   function labelFor(d){
     const p=d.properties||{}; const raw=(p.NAME_1||p.VARNAME_1||p.NAME||'').toString().trim();
     const ar = arNames.get(normalizeKey(raw)); return isArabic ? (ar||raw) : (raw||'');
   }
   function fontSizeFor(path, f){
     const a=Math.max(1, path.area(f));
     return Math.round(10 + Math.min(6, Math.log(a)/2.2)); // 10–16px
   }
   // رسم الخريطة
   function drawMap(geo){
     window.__GEO__ = geo;
     const projection = d3.geoMercator().fitSize([1200,980], geo);
     const path = d3.geoPath(projection);
     const bboxAll = path.bounds(geo);
     window.__bbox__ = bboxAll;
     gPol.selectAll('path.gov')
       .data(geo.features)
       .join('path')
       .attr('class','gov')
       .attr('d', path)
       .attr('id',(_,i)=>'gov-'+i)
       .on('click', function(e,d){
         const already = d3.select(this).classed('active');
         gPol.selectAll('path.gov').classed('active',false);
         if(!already){ d3.select(this).classed('active',true); activeId=this.id; zoomTo(path.bounds(d),40,1.8); }
         else { activeId=null; zoomTo(bboxAll,0,1.15); }
       })
       .on('mouseenter', (e,d)=> !activeId && zoomTo(path.bounds(d),24,1.4))
       .on('mouseleave', ()=> !activeId && zoomTo(bboxAll,0,1.15));
     drawProvinceLabels(geo, path);
     drawIslands(projection);
     zoomTo(bboxAll, 0, 1.15); // قريب افتراضيًا
   }
   function drawProvinceLabels(geo, pathOpt){
     const path = pathOpt || d3.geoPath(d3.geoMercator().fitSize([1200,980], geo));
     const sel = gLbl.selectAll('text.label').data(geo.features,(_,i)=>'lbl-'+i);
     sel.join(
       enter => enter.append('text')
         .attr('class','label')
         .attr('x',d=>path.centroid(d)[0])
         .attr('y',d=>path.centroid(d)[1])
         .style('font-size',d=>fontSizeFor(path,d)+'px')
         .text(labelFor),
       update => update
         .attr('x',d=>path.centroid(d)[0])
         .attr('y',d=>path.centroid(d)[1])
         .style('font-size',d=>fontSizeFor(path,d)+'px')
         .text(labelFor)
     );
   }
   function drawIslands(projection){
     if(!projection && window.__GEO__){
       projection = d3.geoMercator().fitSize([1200,980], window.__GEO__);
     }
     gIsl.selectAll('*').remove();
     islands.forEach(is=>{
       const p = projection([is.lon,is.lat]); if(!p) return;
       const [x,y]=p;
       gIsl.append('circle').attr('class','island-dot').attr('cx',x).attr('cy',y).attr('r',is.r||2.5);
       gIsl.append('text').attr('class','island-label').attr('x',x+(is.dx||8)).attr('y',y+(is.dy||2))
         .style('font-size',(is.fs||10)+'px').text(isArabic?is.ar:is.en);
     });
   }
   function zoomTo(bounds, pad=28, factor=1.15){
     const [[x0,y0],[x1,y1]]=bounds;
     const width=1200, height=980;
     const dx=x1-x0+pad, dy=y1-y0+pad;
     const cx=(x0+x1)/2, cy=(y0+y1)/2;
     const scale=Math.max(1, Math.min(8, (0.92/Math.max(dx/width, dy/height))*factor));
     const tx=width/2  - scale*cx;
     const ty=height/2 - scale*cy;
     g.transition().duration(450).attr('transform',`translate(${tx},${ty}) scale(${scale})`);
   }
   // ====== 1) مسار Flutter: يستدعى من Dart ======
   window.loadMapFromFlutter = function(json){
     try{ const obj=(typeof json==='string')?JSON.parse(json):json; drawMap(obj); }
     catch(e){ alert('❌ GeoJSON غير صالح من Flutter'); console.error(e); }
   };
   // ====== 2) مسار المتصفح: Fallback محلي ======
   (async function(){
     try{
       // ملاحظة: "./" مهمّة لأن الـ baseUrl في Flutter يكون 'assets/web/'
       const resp = await fetch('./geo/oman_governorates.geojson');
       if (resp.ok){
         const geo = await resp.json();
         drawMap(geo);
       }
     }catch(e){
       // في Flutter قد يفشل fetch بسبب scheme file:// — لا مشكلة، Flutter سيرسل البيانات
       console.log('Browser fallback failed (OK on Flutter):', e);
     }
   })();
</script>
</body>
</html>